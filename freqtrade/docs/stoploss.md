# ストップロス

「stoploss」設定パラメータは、販売をトリガーする損失率です。
たとえば、特定の取引で利益が -10% を下回った場合、値「-0.10」では即時売却が行われます。このパラメータはオプションです。
ストップロスの計算には手数料が含まれるため、-10% のストップロスはエントリー ポイントのちょうど 10% 下に配置されます。

ほとんどの戦略ファイルには、最適な「ストップロス」値がすでに含まれています。

!!! Info
    このファイルに記載されているすべてのストップロス プロパティは、ストラテジーまたは構成で設定できます。  
    <ins>構成値は戦略値をオーバーライドします。</ins>

## 取引所/Freqtrade でのストップロス

これらのストップロス モードは *取引所* または *取引所外* にすることができます。

これらのモードは次の値で構成できます。
``` python
    'emergency_exit': 'market',
    'stoploss_on_exchange': False
    'stoploss_on_exchange_interval': 60,
    'stoploss_on_exchange_limit_ratio': 0.99
```
取引所のストップロスは次の取引所でのみサポートされており、すべての取引所がストップリミットとストップマーケットの両方をサポートしているわけではありません。
使用可能なモードが 1 つだけの場合、Order-type は無視されます。

??? info「サポートされている取引所とストップロスのタイプ」
    
    --8<-- "includes/exchange-features.md"

!!! Note "タイトなストップロス"
    <ins>取引所でストップロスを使用する場合は、ストップロス値を低すぎたり、きつすぎたりしないでください。</ins>  
    低く/タイトに設定すると、注文で約定を逃すリスクが大きくなり、ストップロスが機能しなくなります。

### stoploss_on_exchange と stoploss_on_exchange_limit_ratio

為替のストップロスを有効または無効にします。
ストップロスが *取引所上* にある場合、買い注文が約定した直後にストップロスの指値注文が取引所に発注されることを意味します。これにより、注文の実行は純粋に取引所内で行われ、ネットワークのオーバーヘッドが発生する可能性がないため、市場の突然の暴落から保護されます。

「stoploss_on_exchange」が指値注文を使用する場合、取引所には stoploss_price と Limit 価格の 2 つの価格が必要です。  
「ストップロス」は、指値注文が行われるストップ価格を定義します。指値はこれをわずかに下回る必要があります。  
取引所が指値注文と市場ストップロス注文の両方をサポートしている場合、「ストップロス」の値を使用してストップロスのタイプが決定されます。  

計算例: 資産を 100\$ で購入しました。  
ストップ価格が 95\$ の場合、指値は `95 * 0.99 = 94.05$` になります。したがって、指値注文約定は 95$ と 94.05$ の間で発生する可能性があります。  

たとえば、ストップロスが取引所にあり、トレーリング ストップロスが有効で、市場が上昇していると仮定すると、ボットは自動的に前のストップロス注文をキャンセルし、前のストップロス注文よりも高いストップ値で新しい注文を発注します。

!!! Note
    「stoploss_on_exchange」が有効で、ストップロスが取引所で手動でキャンセルされた場合、ボットは新しいストップロス注文を作成します。

### stoploss_on_exchange_interval

取引所でのストップロスの場合は、「stoploss_on_exchange_interval」と呼ばれる別のパラメーターがあります。これは、ボットがストップロスをチェックし、必要に応じて更新する間隔を秒単位で構成します。  
ボットはこれらを 5 秒ごと (反復ごと) に行うことはできません。そうしないと、取引所によって禁止されてしまいます。
したがって、このパラメーターはボットにストップロス注文を更新する頻度を指示します。デフォルト値は 60 (1 分) です。
誤ってキャンセルした場合、これと同じロジックで取引所にストップロス注文が再適用されます。

### stoploss_price_type

!!! Warning "先物のみに適用されます"
    「stoploss_price_type」は、先物市場 (利用可能な取引所) にのみ適用されます。
    Freqtrade は起動時にこの設定の検証を実行します。取引所に対して無効な設定が選択されている場合は起動に失敗します。
サポートされる価格タイプは取引所ごとに異なります。どの価格タイプがサポートされているかについては、取引所に確認してください。

先物市場の取引所でのストップロスは、さまざまな価格タイプでトリガーされる可能性があります。
為替用語でのこれらの価格の名前はさまざまですが、通常は「最終」（または「契約価格」）、「マーク」、「インデックス」のようなものです。

この設定で許容される値は `"last"`、`"mark"`、および `"index"` です。freqtrade はこれらを対応する API タイプに自動的に転送し、それに応じて [取引所のストップロス](#stoploss_on_exchange-and-stoploss_on_exchange_limit_ratio) 注文を配置します。

### 強制終了

`force_exit` はオプションの値で、デフォルトは `exit` と同じ値で、Telegram または Rest API から `/forceexit` コマンドを送信するときに使用されます。

### 強制入力

`force_entry` はオプションの値で、デフォルトは `entry` と同じ値で、Telegram または Rest API から `/forceentry` コマンドを送信するときに使用されます。

### 緊急出口

「emergency_exit」はオプションの値で、デフォルトは「market」で、為替注文のストップロスの作成が失敗した場合に使用されます。
以下は、戦略または構成ファイルで変更されない場合に使用されるデフォルトです。

戦略ファイルの例:
``` python
order_types = {
    "entry": "limit",
    "exit": "limit",
    "emergency_exit": "market",
    "stoploss": "market",
    "stoploss_on_exchange": True,
    "stoploss_on_exchange_interval": 60,
    "stoploss_on_exchange_limit_ratio": 0.99
}
```
## ストップロスのタイプ

この段階では、ボットには次のストップロス サポート モードが含まれています。

1. 静的ストップロス。
2. トレーリングストップロス。
3. トレーリングストップロス、カスタムプラス損失。
4. トレーリングストップロスは、取引が特定のオフセットに達した場合にのみ適用されます。
5. [カスタムストップロス関数](strategy-callbacks.md#custom-stoploss)

### 静的ストップロス

これは非常に簡単で、x のストップロスを (価格の比率、つまり x * 価格の 100%) と定義します。これは、損失が定義された損失を超えると資産を売却しようとします。

ストップロスの例:
``` python
    stoploss = -0.10
```
たとえば、単純化した数学は次のようになります。

* ボットは 100 ドルの価格で資産を購入します
* ストップロスは -10% で定義されます
*資産が90ドルを下回るとストップロスがトリガーされます

### トレーリングストップロス

この初期値は、静的なストップロスを定義する場合と同様に、「stoploss」です。
トレーリングストップロスを有効にするには:
``` python
    stoploss = -0.10
    trailing_stop = True
```
これにより、資産の価格が上昇するたびに自動的にストップロスを引き上げるアルゴリズムが有効になります。

たとえば、単純化した数学は次のようになります。

* ボットは 100 ドルの価格で資産を購入します
* ストップロスは -10% で定義されます
*資産が90ドルを下回るとストップロスがトリガーされます
* 資産が 102 ドルに増加したと仮定します
* ストップロスは 102$ の -10% = 91.8$ になります。
* 現在、資産の価値は 101\$ に下がりますが、ストップロスは 91.8$ のままで、91.8$ でトリガーされます。

要約すると、ストップロスは常に観測された最高価格の -10% になるように調整されます。

### トレーリングストップロス、異なるプラスの損失

買いで赤字の場合（買い - 手数料）にデフォルトのストップロスを設定することもできますが、プラスの結果（または定義したオフセット）に達すると、システムは異なる値の新しいストップロスを利用します。
たとえば、デフォルトのストップロスは -10% ですが、収益性 (0.1% など) に達すると、別のトレーリングストップロスが使用されます。

!!! Note
    損益分岐点で利益が得られた場合にのみストップロスを変更したい場合 (ほとんどのユーザーが望んでいること)、[オフセットを有効](#trailing-stop-loss-only-once-the-trade-has-reached-a-certain-offset) にして次のセクションを参照してください。

どちらの値も、`trailing_stop` を true に設定し、`trailing_stop_positive` に値を設定する必要があります。
``` python
    stoploss = -0.10
    trailing_stop = True
    trailing_stop_positive = 0.02
    trailing_stop_positive_offset = 0.0
    trailing_only_offset_is_reached = False  # Default - not necessary for this example
```
たとえば、単純化した数学は次のようになります。

* ボットは 100 ドルの価格で資産を購入します
* ストップロスは -10% で定義されます
*資産が90ドルを下回るとストップロスがトリガーされます
* 資産が 102 ドルに増加したと仮定します
* ストップロスは 102$ = 99.96 ドルの -2% になります (99.96$ ストップロスは固定され、資産価格の増加に -2% で追従します)
* 現在、資産の価値は 101\$ に下がりますが、ストップロスは 99.96$ のままで、99.96$ でトリガーされます。

0.02 は -2% のストップロスに相当します。
これより前は、「stoploss」がトレーリングのストップロスに使用されます。

!!! Tip "オフセットを使用してストップロスを変更する"
    `trailing_stop_positive_offset` を使用して、`trailing_stop_positive_offset` を `trailing_stop_positive` よりも高く設定することで、新しいトレーリング ストップロスが確実に利益を生むようにします。最初の新しいストップロス値はすでに利益を確定させています。

    単純化した計算の例:
    ``` python
        stoploss = -0.10
        trailing_stop = True
        trailing_stop_positive = 0.02
        trailing_stop_positive_offset = 0.03
    ```
* ボットは 100 ドルの価格で資産を購入します
    * ストップロスは -10% で定義されているため、資産が 90$ を下回るとストップロスがトリガーされます。
    * 資産が 102 ドルに増加したと仮定します
    * ストップロスは 91.8$ になります - 観察された最高レートより 10% 低いです
    * 資産が 103.5 ドルに増加すると仮定します (設定されたオフセットを上回ります)
    * ストップロスは 103.5$ の -2% = 101.43$ になります。
    * 現在、資産の価値は 102\$ に低下していますが、ストップロスは依然として 101.43$ であり、価格が 101.43$ を下回るとトリガーされます。

### トレーリングストップロスは取引が特定のオフセットに達した場合のみ

オフセットに達するまで静的なストップロスを維持し、市場が反転したら取引を追跡して利益を確定することもできます。

「trailing_only_offset_is_reached = True」の場合、トレーリング ストップロスはオフセットに達した場合にのみ有効になります。それまでは、ストップロスは設定された「ストップロス」のままであり、後続しません。
この値を「trailing_only_offset_is_reached=False」のままにすると、資産価格が初期エントリー価格を超えて上昇するとすぐに、トレーリングストップロスがトレーリングを開始できるようになります。

このオプションは `trailing_stop_positive` の有無に関係なく使用できますが、オフセットとして `trailing_stop_positive_offset` を使用します。

構成 (オフセットは購入価格 + 3%):
``` python
    stoploss = -0.10
    trailing_stop = True
    trailing_stop_positive = 0.02
    trailing_stop_positive_offset = 0.03
    trailing_only_offset_is_reached = True
```
たとえば、単純化した数学は次のようになります。

* ボットは 100 ドルの価格で資産を購入します
* ストップロスは -10% で定義されます
*資産が90ドルを下回るとストップロスがトリガーされます
*資産が設定されたオフセット以上に増加しない限り、ストップロスは90ドルのままになります
* 資産が 103$ に増加したと仮定します (オフセットが設定されている場合)
* ストップロスは 103$ の -2% = 100.94$ になります。
* 現在、資産の価値は 101\$ に下落していますが、ストップロスは依然として 100.94$ であり、100.94$ でトリガーされます。

!!! Tip
    この値 (`trailing_stop_positive_offset`) を最小 ROI よりも低くするようにしてください。そうでない場合は、最小 ROI が最初に適用され、取引が売却されます。

## ストップロスとレバレッジ

ストップロスは「この取引のリスク」と考える必要があります。つまり、100 ドルの取引で 10% のストップロスは、この取引で 10 ドル (10%) 損失することを覚悟していることを意味します。これは、価格が 10% 下側に動いた場合にトリガーされます。

レバレッジを使用する場合も、同じ原則が適用されます。ストップロスは取引のリスク (損失を許容できる金額) を定義します。

したがって、10 倍の取引では 10% のストップロスが 1% の価格変動でトリガーされます。
あなたのステーク額 (自己資金) が 100 ドルの場合、この取引は 10 倍 (レバレッジ後) で 1000 ドルになります。
価格が 1% 変動した場合、つまり自己資本の 10 ドルを失ったことになります。したがって、この場合はストップロスがトリガーされます。

この点に必ず注意し、きつすぎるストップロスを使用しないようにしてください（10倍のレバレッジでは、10％のリスクは小さすぎて取引が少し「呼吸」できる可能性があります）。

## オープントレードでのストップロスの変更

オープントレードのストップロスは、設定または戦略の値を変更し、`/reload_config` コマンドを使用することで変更できます (または、ボットを完全に停止して再起動することもできます)。

新しいストップロス値はオープン取引に適用されます (そして、対応するログメッセージが生成されます)。

### 制限事項

「trailing_stop」が有効で、ストップロスがすでに調整されている場合、ストップロス値は変更できません。
